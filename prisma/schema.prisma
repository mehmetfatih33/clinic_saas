generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Clinic {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  createdAt           DateTime             @default(now())
  workSchedule        Json?
  isActive            Boolean              @default(true)
  
  // SMTP Settings
  smtpHost            String?
  smtpPort            Int?
  smtpUser            String?
  smtpPass            String?
  smtpFrom            String?

  appointments        Appointment[]
  assessments         Assessment[]
  assignments         Assignment[]
  audits              AuditLog[]
  cashTransactions    CashTransaction[]
  clinicPlans         ClinicPlan[]
  feeSchedules        FeeSchedule[]
  financeAccounts     FinanceAccount[]
  financeCategories   FinanceCategory[]
  financeTransactions FinanceTransaction[]
  notes               Note[]
  patients            Patient[]
  payments            Payment[]
  paymentPlans        PaymentPlan[]
  payouts             Payout[]
  payrollEntries      PayrollEntry[]
  rooms               Room[]
  specialistFees      SpecialistFee[]
  specialistProfiles  SpecialistProfile[]
  timeOffs            SpecialistTimeOff[]
  transactions        Transaction[]
  users               User[]
  userClinics         UserClinic[]
  tasks               Task[]
  documents           Document[]
  prescriptions       Prescription[]
  reminders           Reminder[]
}

model User {
  id                         String               @id @default(cuid())
  email                      String               @unique
  name                       String?
  role                       Role                 @default(ASISTAN)
  passwordHash               String?
  clinicId                   String
  phone                      String?
  address                    String?
  image                      String?
  createdAt                  DateTime             @default(now())
  accounts                   Account[]
  appointments               Appointment[]        @relation("SpecialistAppointments")
  assessments                Assessment[]         @relation("UserAssessments")
  assignments                Assignment[]         @relation("AssignmentSpecialist")
  audits                     AuditLog[]
  cashTransactions           CashTransaction[]    @relation("CashTransactionSpecialist")
  feeSchedules               FeeSchedule[]
  financeTransactionsCreated FinanceTransaction[] @relation("FinanceTransactionCreatedBy")
  financeTransactionsAsStaff FinanceTransaction[] @relation("FinanceTransactionStaff")
  notes                      Note[]               @relation("NoteAuthor")
  assignedPatients           Patient[]            @relation("PatientSpecialist")
  payments                   Payment[]            @relation("SpecialistPayments")
  paymentPlans               PaymentPlan[]
  payouts                    Payout[]
  payrollEntries             PayrollEntry[]       @relation("PayrollStaff")
  sessions                   Session[]
  specialist                 SpecialistProfile?
  timeOffs                   SpecialistTimeOff[]
  transactions               Transaction[]
  clinic                     Clinic               @relation(fields: [clinicId], references: [id])
  clinics                    UserClinic[]
  assignedTasks              Task[]               @relation("TaskAssignedTo")
  createdTasks               Task[]               @relation("TaskCreatedBy")
  uploadedDocuments          Document[]
  prescriptions              Prescription[]
  notifications              Notification[]
  pushSubscriptions          PushSubscription[]

  @@index([clinicId, role])
  @@index([clinicId])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SpecialistProfile {
  id            String          @id @default(cuid())
  clinicId      String
  userId        String          @unique
  branch        String?
  bio           String?
  defaultShare  Float           @default(50)
  hourlyFee     Float           @default(0)
  totalPatients Int             @default(0)
  totalRevenue  Float           @default(0)
  fees          SpecialistFee[]
  clinic        Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id])

  @@index([clinicId])
}

model SpecialistTimeOff {
  id           String    @id @default(cuid())
  clinicId     String
  specialistId String
  start        DateTime
  end          DateTime?
  reason       String?
  createdAt    DateTime  @default(now())
  clinic       Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  specialist   User      @relation(fields: [specialistId], references: [id])

  @@index([clinicId])
  @@index([specialistId])
  @@index([start, end])
}

model Patient {
  id                  String               @id @default(cuid())
  clinicId            String
  name                String
  email               String?
  phone               String?
  address             String?
  reference           String?
  fee                 Float?
  assignedToId        String?
  specialistShare     Float?
  totalSessions       Int                  @default(0)
  totalPayments       Float                @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  notes               String?
  birthDate           DateTime?
  diagnosis           String?
  appointments        Appointment[]
  assessments         Assessment[]
  assignments         Assignment[]
  cashTransactions    CashTransaction[]    @relation("CashTransactionPatient")
  financeTransactions FinanceTransaction[] @relation("FinanceTransactionPatient")
  patientNotes        Note[]
  specialist          User?                @relation("PatientSpecialist", fields: [assignedToId], references: [id])
  clinic              Clinic               @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  payments            Payment[]
  paymentPlans        PaymentPlan[]
  transactions        Transaction[]
  documents           Document[]
  prescriptions       Prescription[]
  reminders           Reminder[]

  @@index([clinicId])
  @@index([name])
  @@index([phone])
  @@index([assignedToId])
}

model FeeSchedule {
  id             String          @id @default(cuid())
  clinicId       String
  title          String
  amount         Int
  createdBy      String
  createdAt      DateTime        @default(now())
  assignments    Assignment[]
  clinic         Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  creator        User            @relation(fields: [createdBy], references: [id])
  specialistFees SpecialistFee[]

  @@unique([clinicId, title])
  @@index([clinicId])
}

model SpecialistFee {
  id           String            @id @default(cuid())
  clinicId     String
  specialistId String
  feeId        String
  customAmount Int?
  splitClinic  Int?
  splitDoctor  Int?
  clinic       Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  fee          FeeSchedule       @relation(fields: [feeId], references: [id], onDelete: Cascade)
  specialist   SpecialistProfile @relation(fields: [specialistId], references: [id], onDelete: Cascade)

  @@unique([specialistId, feeId])
  @@index([clinicId])
}

model Assignment {
  id           String       @id @default(cuid())
  clinicId     String
  patientId    String
  specialistId String
  feeId        String?
  customAmount Int?
  splitClinic  Int?
  splitDoctor  Int?
  status       String       @default("active")
  createdAt    DateTime     @default(now())
  clinic       Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  fee          FeeSchedule? @relation(fields: [feeId], references: [id])
  patient      Patient      @relation(fields: [patientId], references: [id])
  specialist   User         @relation("AssignmentSpecialist", fields: [specialistId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([specialistId])
}

model Appointment {
  id           String            @id @default(cuid())
  clinicId     String
  patientId    String
  specialistId String
  roomId       String?
  date         DateTime
  duration     Int               @default(60)
  status       AppointmentStatus @default(SCHEDULED)
  notes        String?
  createdAt    DateTime          @default(now())
  clinic       Clinic            @relation(fields: [clinicId], references: [id])
  patient      Patient           @relation(fields: [patientId], references: [id])
  room         Room?             @relation(fields: [roomId], references: [id])
  specialist   User              @relation("SpecialistAppointments", fields: [specialistId], references: [id])
  sessionNotes Note[]
  reminders    Reminder[]

  @@index([clinicId])
  @@index([patientId])
  @@index([specialistId])
  @@index([roomId])
  @@index([date])
  @@index([clinicId, date])
}

model Room {
  id           String        @id @default(cuid())
  clinicId     String
  name         String
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  appointments Appointment[]
  clinic       Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([clinicId, name])
  @@index([clinicId])
}

model Note {
  id            String         @id @default(cuid())
  clinicId      String
  patientId     String
  authorId      String
  appointmentId String?
  content       String
  visibility    NoteVisibility @default(PRIVATE)
  createdAt     DateTime       @default(now())
  appointment   Appointment?   @relation(fields: [appointmentId], references: [id])
  author        User           @relation("NoteAuthor", fields: [authorId], references: [id])
  clinic        Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([patientId])
  @@index([authorId])
}

model AuditLog {
  id        String   @id @default(cuid())
  clinicId  String
  actorId   String
  action    String
  entity    String
  entityId  String
  meta      Json?
  createdAt DateTime @default(now())
  actor     User     @relation(fields: [actorId], references: [id])
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId, createdAt])
  @@index([createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Assessment {
  id           String         @id @default(cuid())
  clinicId     String
  patientId    String
  specialistId String
  type         AssessmentType
  answers      Json
  total        Int
  createdAt    DateTime       @default(now())
  clinic       Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient      Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  specialist   User           @relation("UserAssessments", fields: [specialistId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([specialistId])
  @@index([createdAt])
}

model Payment {
  id               String            @id @default(cuid())
  patientId        String
  specialistId     String
  clinicId         String
  amount           Float
  specialistCut    Float
  clinicCut        Float
  createdAt        DateTime          @default(now())
  cashTransactions CashTransaction[] @relation("CashTransactionPayment")
  clinic           Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient          Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  specialist       User              @relation("SpecialistPayments", fields: [specialistId], references: [id])

  @@index([patientId])
  @@index([specialistId])
  @@index([clinicId])
  @@index([createdAt])
}

model PaymentPlan {
  id           String     @id @default(cuid())
  clinicId     String
  patientId    String?
  specialistId String?
  type         PlanType
  amount       Float
  dueDate      DateTime
  description  String?
  status       PlanStatus @default(PLANNED)
  createdAt    DateTime   @default(now())
  clinic       Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient      Patient?   @relation(fields: [patientId], references: [id])
  specialist   User?      @relation(fields: [specialistId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([specialistId])
  @@index([dueDate])
  @@index([status])
}

model Plan {
  id          String       @id @default(cuid())
  slug        String       @unique
  name        String
  description String?
  features    Json
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  clinicPlans ClinicPlan[]
}

model ClinicPlan {
  id        String    @id @default(cuid())
  clinicId  String
  planId    String
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)
  billingCycle       BillingCycle @default(MONTHLY)
  lastReminderSentAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  clinic    Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  plan      Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([planId])
  @@index([isActive])
}

model Transaction {
  id           String          @id @default(cuid())
  clinicId     String
  patientId    String?
  specialistId String?
  type         TransactionType
  amount       Float
  description  String?
  date         DateTime        @default(now())
  createdAt    DateTime        @default(now())
  clinic       Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient      Patient?        @relation(fields: [patientId], references: [id])
  specialist   User?           @relation(fields: [specialistId], references: [id])

  @@index([clinicId])
  @@index([patientId])
  @@index([specialistId])
  @@index([date])
}

model Payout {
  id           String          @id @default(cuid())
  clinicId     String
  targetUserId String
  type         PayoutType
  category     PayoutCategory?
  amount       Float
  note         String?
  date         DateTime        @default(now())
  periodMonth  Int?
  periodYear   Int?
  createdAt    DateTime        @default(now())
  clinic       Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  target       User            @relation(fields: [targetUserId], references: [id])

  @@index([clinicId])
  @@index([targetUserId])
  @@index([type])
  @@index([periodYear, periodMonth])
}

model FinanceAccount {
  id           String               @id @default(cuid())
  clinicId     String
  name         String
  type         FinanceAccountType
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  clinic       Clinic               @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  transactions FinanceTransaction[]

  @@index([clinicId])
}

model FinanceCategory {
  id               String                 @id @default(cuid())
  clinicId         String
  name             String
  type             FinanceTransactionType
  createdAt        DateTime               @default(now())
  cashTransactions CashTransaction[]      @relation("CashCategoryRel")
  clinic           Clinic                 @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  transactions     FinanceTransaction[]

  @@index([clinicId])
}

model FinanceTransaction {
  id             String                 @id @default(cuid())
  clinicId       String
  date           DateTime
  type           FinanceTransactionType
  amount         Float
  description    String?
  accountId      String?
  categoryId     String?
  staffId        String?
  patientId      String?
  createdById    String?
  account        FinanceAccount?        @relation(fields: [accountId], references: [id])
  category       FinanceCategory?       @relation(fields: [categoryId], references: [id])
  clinic         Clinic                 @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  createdBy      User?                  @relation("FinanceTransactionCreatedBy", fields: [createdById], references: [id])
  patient        Patient?               @relation("FinanceTransactionPatient", fields: [patientId], references: [id])
  staff          User?                  @relation("FinanceTransactionStaff", fields: [staffId], references: [id])
  payrollEntries PayrollEntry[]         @relation("PayrollTransaction")

  @@index([clinicId])
  @@index([date])
  @@index([type])
}

model PayrollEntry {
  id            String              @id @default(cuid())
  clinicId      String
  staffId       String
  periodStart   DateTime
  periodEnd     DateTime
  grossAmount   Float
  netAmount     Float
  status        PayrollStatus       @default(PLANNED)
  paidAt        DateTime?
  transactionId String?
  clinic        Clinic              @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  staff         User                @relation("PayrollStaff", fields: [staffId], references: [id])
  transaction   FinanceTransaction? @relation("PayrollTransaction", fields: [transactionId], references: [id])

  @@index([clinicId])
  @@index([staffId])
}

model CashTransaction {
  id             String                  @id @default(cuid())
  clinicId       String
  type           CashTransactionType
  category       CashTransactionCategory
  amount         Float
  paymentId      String?
  patientId      String?
  specialistId   String?
  cashCategoryId String?
  description    String?
  date           DateTime                @default(now())
  createdAt      DateTime                @default(now())
  cashCategory   FinanceCategory?        @relation("CashCategoryRel", fields: [cashCategoryId], references: [id])
  clinic         Clinic                  @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient        Patient?                @relation("CashTransactionPatient", fields: [patientId], references: [id])
  payment        Payment?                @relation("CashTransactionPayment", fields: [paymentId], references: [id])
  specialist     User?                   @relation("CashTransactionSpecialist", fields: [specialistId], references: [id])

  @@index([clinicId])
  @@index([date])
  @@index([type])
  @@index([category])
  @@index([cashCategoryId])
}

model UserClinic {
  id        String   @id @default(cuid())
  userId    String
  clinicId  String
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, clinicId])
  @@index([clinicId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  isRead    Boolean  @default(false)
  type      String   @default("INFO")
  link      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id           String       @id @default(cuid())
  clinicId     String
  title        String
  description  String?
  status       TaskStatus   @default(TODO)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?
  assignedToId String?
  createdById  String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  clinic       Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  assignedTo   User?        @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  createdBy    User         @relation("TaskCreatedBy", fields: [createdById], references: [id])

  @@index([clinicId])
  @@index([assignedToId])
}

model Document {
  id           String   @id @default(cuid())
  clinicId     String
  patientId    String
  name         String
  url          String
  type         String
  size         Int
  uploadedById String
  createdAt    DateTime @default(now())

  clinic       Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient      Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@index([clinicId])
  @@index([patientId])
}

model Prescription {
  id           String             @id @default(cuid())
  clinicId     String
  patientId    String
  specialistId String
  diagnosis    String?
  notes        String?
  date         DateTime           @default(now())
  items        PrescriptionItem[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  clinic       Clinic             @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient      Patient            @relation(fields: [patientId], references: [id])
  specialist   User               @relation(fields: [specialistId], references: [id])

  @@index([clinicId])
  @@index([patientId])
}

model PrescriptionItem {
  id             String       @id @default(cuid())
  prescriptionId String
  medication     String
  dosage         String
  frequency      String
  duration       String?
  instructions   String?
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
}

model Reminder {
  id            String         @id @default(cuid())
  clinicId      String
  patientId     String?
  appointmentId String?
  type          ReminderType
  status        ReminderStatus @default(PENDING)
  scheduledFor  DateTime
  sentAt        DateTime?
  message       String
  createdAt     DateTime       @default(now())

  clinic        Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient       Patient?       @relation(fields: [patientId], references: [id])
  appointment   Appointment?   @relation(fields: [appointmentId], references: [id])

  @@index([clinicId])
  @@index([scheduledFor])
}

enum Role {
  ADMIN
  ASISTAN
  UZMAN
  PERSONEL
  SUPER_ADMIN
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELED
}

enum NoteVisibility {
  PRIVATE
  INTERNAL
}

enum AssessmentType {
  PHQ9
  GAD7
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum PlanStatus {
  PLANNED
  PAID
  CANCELED
}

enum PlanType {
  INCOMING
  OUTGOING
}

enum PayoutType {
  SPECIALIST
  STAFF
}

enum PayoutCategory {
  SALARY
  BONUS
  OTHER
}

enum FinanceTransactionType {
  INCOME
  EXPENSE
}

enum FinanceAccountType {
  CASH
  BANK
  OTHER
}

enum PayrollStatus {
  PLANNED
  PAID
}

enum CashTransactionType {
  IN
  OUT
}

enum CashTransactionCategory {
  HASTA_ODEME
  UZMAN_ODEME
  MAAS
  KIRA
  DIGER_GIDER
  DIGER_GELIR
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum ReminderType {
  SMS
  EMAIL
}

enum ReminderStatus {
  PENDING
  SENT
  FAILED
  CANCELED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}
